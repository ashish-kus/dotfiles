#!/usr/bin/env bash
# Color Script for Hyprland Rice
# Generates color configs for mako, waybar, hyprland, foot, and rofi
set -e

# Configuration paths
COLORS_CSS="$HOME/.colors.css"
MAKO_CONFIG="$HOME/.config/mako/config"
MAKO_BASE="$HOME/.config/mako/base.conf"
HYPR_COLORS="$HOME/.config/hypr/hyprcolor.conf"
ROFI_COLORS="$HOME/.config/rofi/colors.rasi"
# FOOT_CONFIG="$HOME/.config/foot/foot.ini"

# Function to convert hex to RGB
hex_to_rgb() {
  local hex="${1#\#}"
  printf "%d %d %d" "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

# Function to convert hex to rgba format for rofi
hex_to_rgba() {
  local hex="${1#\#}"
  local r=$((16#${hex:0:2}))
  local g=$((16#${hex:2:2}))
  local b=$((16#${hex:4:2}))
  printf "rgba(%d, %d, %d, 100%%)" "$r" "$g" "$b"
}

# Function to calculate complementary color
get_complementary() {
  local hex="${1#\#}"
  local r=$((16#${hex:0:2}))
  local g=$((16#${hex:2:2}))
  local b=$((16#${hex:4:2}))

  # Calculate complementary by inverting RGB
  r=$((255 - r))
  g=$((255 - g))
  b=$((255 - b))

  printf "#%02X%02X%02X" "$r" "$g" "$b"
}

# Validate hex color
validate_color() {
  if [[ ! $1 =~ ^#[0-9A-Fa-f]{6}$ ]]; then
    echo "Error: Invalid color format '$1'. Use #RRGGBB format."
    exit 1
  fi
}

# Parse arguments
if [ $# -eq 0 ] || [ $# -gt 2 ]; then
  echo "Usage: $0 <primary_color> [secondary_color]"
  echo "Example: $0 '#F8CF7C' '#BF8615'"
  echo "Example: $0 '#F8CF7C'  (auto-generates complementary)"
  exit 1
fi

PRIMARY="$1"
validate_color "$PRIMARY"

if [ $# -eq 2 ]; then
  SECONDARY="$2"
  validate_color "$SECONDARY"
else
  SECONDARY=$(get_complementary "$PRIMARY")
  echo "Generated complementary color: $SECONDARY"
fi

# Generate colors.css
cat >"$COLORS_CSS" <<EOF
/* Generated color scheme */
@define-color active $PRIMARY;
@define-color secondary $SECONDARY;
EOF
echo "âœ“ Generated $COLORS_CSS"

# Generate Hyprland colors config
mkdir -p "$(dirname "$HYPR_COLORS")"
cat >"$HYPR_COLORS" <<EOF
# Hyprland color configuration
# Generated by color script

\$active = ${PRIMARY#\#}
\$secondary = ${SECONDARY#\#}
EOF
echo "âœ“ Generated $HYPR_COLORS"

# Generate Rofi colors config
mkdir -p "$(dirname "$ROFI_COLORS")"
cat >"$ROFI_COLORS" <<EOF
/* Rofi color configuration
 * Generated by color script
 */

* {
  debug:                          rgba(225, 000, 000, 100%);        
  bg:                             rgba(32, 29, 42, 0.3);
  text:                           rgba(255, 255, 255, 100%);
  primery:                        $(hex_to_rgba "$PRIMARY");
  secondary:                      $(hex_to_rgba "$SECONDARY");
  transparent:                    rgba(255, 255, 255, 0%);
}
EOF
echo "âœ“ Generated $ROFI_COLORS"

# Generate mako config
mkdir -p "$(dirname "$MAKO_CONFIG")"

# Check if base.conf exists
if [ ! -f "$MAKO_BASE" ]; then
  echo "Error: Base config not found at $MAKO_BASE"
  exit 1
fi

# Copy base config and append colors
cat "$MAKO_BASE" >"$MAKO_CONFIG"
cat >>"$MAKO_CONFIG" <<EOF

# Color overrides
text-color=$PRIMARY
border-color=$PRIMARY
EOF

makoctl reload
notify-send "Theme Updated" "Colors have been changed successfully ðŸŽ¨"
echo "âœ“ Generated $MAKO_CONFIG from base"

# Generate foot config
# mkdir -p "$(dirname "$FOOT_CONFIG")"
# cat >"$FOOT_CONFIG" <<EOF
# Foot terminal configuration
# [colors]
# foreground=ffffff
# background=${SECONDARY#\#}
# regular0=000000
# regular1=ff0000
# regular2=00ff00
# regular3=ffff00
# regular4=0000ff
# regular5=ff00ff
# regular6=00ffff
# regular7=ffffff
# bright0=808080
# bright1=ff8080
# bright2=80ff80
# bright3=ffff80
# bright4=8080ff
# bright5=ff80ff
# bright6=80ffff
# bright7=ffffff
# [cursor]
# color=${SECONDARY#\#} ${PRIMARY#\#}
# EOF
# echo "âœ“ Generated $FOOT_CONFIG"

echo ""
echo "Color scheme applied!"
echo "Primary: $PRIMARY"
echo "Secondary: $SECONDARY"
echo ""
echo "Import colors in your configs:"
pgrep -x waybar &>/dev/null && killall -q waybar -c ~/.config/waybar/config.jsonc
waybar &>/dev/null &
echo "  Waybar/Rofi: @import '$COLORS_CSS';"
echo "  Hyprland:    source = $HYPR_COLORS"
echo "  Rofi:        @import '$ROFI_COLORS'"
